<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>クライアント画面</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    #queueList {
      margin-top: 10px;
      border: 1px solid #ccc;
      padding: 5px;
      max-width: 400px;
    }
    #queueList li {
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <h1>クライアント画面</h1>
  <input type="text" id="videoUrl" placeholder="YouTube URLを入力" />
  <button id="sendBtn">キューに追加</button>

  <h3>再生キュー</h3>
  <ol id="queueList"></ol>

  <script>
    const socket = io();

    // ページ読み込み時に名前を入力させる
    let clientName = prompt("あなたの名前を入力してください", "名無し");
    if (!clientName) clientName = "名無し";
    socket.emit('registerName', clientName);

    document.getElementById('sendBtn').addEventListener('click', () => {
      const url = document.getElementById('videoUrl').value.trim();
      if (url) {
        socket.emit('addVideo', url);
        document.getElementById('videoUrl').value = '';
      }
    });

    socket.on('queueUpdate', ({ currentVideo, queue }) => {
      const listElem = document.getElementById('queueList');
      listElem.innerHTML = '';

      if (!currentVideo && queue.length === 0) {
        listElem.innerHTML = '<li>何も再生されていません</li>';
        return;
      }
      
      // 再生中の曲を一番上に表示
      if (currentVideo) {
        const li = document.createElement('li');
        li.textContent = `[再生中] ${currentVideo.name} - ${currentVideo.videoId}`;

        // スキップボタン（自分が追加者の場合のみ表示）
        if (currentVideo.ownerSocketId === socket.id) {
          const skipBtn = document.createElement('button');
          skipBtn.textContent = 'スキップ';
          skipBtn.style.marginLeft = '8px';
          skipBtn.addEventListener('click', () => {
            if (confirm('現在の曲をスキップしますか？')) {
              socket.emit('skipCurrent');
            }
          });
          li.appendChild(skipBtn);
        }

        listElem.appendChild(li);
      }

      // 残りのキューを表示
      queue.forEach((item) => {
        const li = document.createElement('li');
        li.textContent = `${item.name} - ${item.videoId}`;

        const btn = document.createElement('button');
        btn.textContent = '削除';
        btn.style.marginLeft = '8px';
        btn.addEventListener('click', () => {
          if (confirm(`「${item.videoId}」を削除しますか？`)) {
            socket.emit('removeVideo', item.id);
          }
        });
        li.appendChild(btn);

        listElem.appendChild(li);
      });
    });
    
    socket.on('removeDenied', (id) => {
      alert(`動画の削除権限がありません (id=${id})`);
    });

    socket.on('skipDenied', () => {
      alert('スキップ権限がありません');
    });
  </script>
</body>
</html>
